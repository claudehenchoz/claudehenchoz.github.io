name: Build and Deploy
on:
  push:
    branches:
      - master
  schedule:
    - cron:  '52 4 * * *'

jobs:
  fetch-and-publish-news:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v2.3.1

      - name: Install Calibre ⏳
        run: sudo apt-get install calibre --no-install-recommends

      - name: Install Kepubify ⏳
        run: |
          wget https://github.com/pgaskin/kepubify/releases/latest/download/kepubify-linux-64bit
          chmod +x kepubify-linux-64bit

      - name: Generate Kepubs 📚
        run: |
          mkdir build
          for filename in recipes/*.recipe; do
            ebook-convert "$filename" "build/$(basename "$filename" .recipe).epub" --extra-css ".calibre_navbar {display:none;}" --smarten-punctuation
            cd build
            ../kepubify-linux-64bit "$(basename "$filename" .recipe).epub"
            rm "$(basename "$filename" .recipe).epub"
            cd ..
          done

      - name: Generate index.html 📰
        run: |
          echo "<!DOCTYPE html><html lang='en'><body>" > build/index.html
          cd build
          for filename in *.epub; do
            echo "<a href='$filename'>$filename</a><br/>" >> index.html
          done
          cd ..
          echo "</body></html>" >> build/index.html

      - name: Deploy 🚀
        uses: JamesIves/github-pages-deploy-action@4.1.5
        with:
          branch: gh-pages # The branch the action should deploy to.
          folder: build # The folder the action should deploy.
          single-commit: true
